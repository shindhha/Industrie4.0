<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Devices</title>
<style>
table {border-collapse: collapse; width: 100%;}
th, td {border: 1px solid #ccc; padding: 8px;}
button {margin: 2px;}
input {margin: 2px;}
</style>
</head>
<body>
<h1>Dashboard Devices</h1>

<h2>Ajouter un device</h2>
<form id="addForm">
    <input type="text" placeholder="ID" id="add-id" required>
    <input type="text" placeholder="Name" id="add-name" required>
    <select id="add-type">
        <option value="sensor">Sensor</option>
        <option value="actuator">Actuator</option>
    </select>
    <input type="text" placeholder="Location" id="add-location" required>
    <button type="submit">Ajouter</button>
</form>
<div id="error-msg" style="color:red"></div>

<h2>Liste des devices</h2>
<table id="devices-table">
    <thead>
        <tr>
            <th>ID</th><th>Name</th><th>Type</th><th>Location</th><th>Valeur/Etat</th><th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
async function fetchDevices() {
    try {
        const res = await fetch('http://127.0.0.1:5000/api/devices');
        const devices = await res.json();
        const tbody = document.querySelector('#devices-table tbody');
        tbody.innerHTML = '';
        devices.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.id}</td>
                <td><input type="text" value="${d.name}" data-id="${d.id}" class="edit-name"></td>
                <td>${d.type}</td>
                <td><input type="text" value="${d.location}" data-id="${d.id}" class="edit-location"></td>
                <td>${d.type==='sensor'?d.value:d.state}</td>
                <td>
                    <button onclick="updateDevice('${d.id}')">Modifier</button>
                    <button onclick="deleteDevice('${d.id}')">Supprimer</button>
                    ${d.type==='actuator'?`<button onclick="toggleActuator('${d.id}')">${d.state==='on'?'Éteindre':'Allumer'}</button>`:''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch(err) {
        console.error('Erreur fetch devices:', err);
    }
}

async function addDevice(e) {
    e.preventDefault();
    const data = {
        id: document.getElementById('add-id').value.trim(),
        name: document.getElementById('add-name').value.trim(),
        type: document.getElementById('add-type').value,
        location: document.getElementById('add-location').value.trim()
    };
    try {
        const res = await fetch('http://127.0.0.1:5000/api/devices', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
        });
        if(!res.ok) {
            const err = await res.json();
            document.getElementById('error-msg').innerText = err.error;
            return;
        }
        document.getElementById('error-msg').innerText = '';
        fetchDevices();
        document.getElementById('addForm').reset();
    } catch(err) {
        console.error(err);
    }
}

async function updateDevice(id) {
    const name = document.querySelector(`.edit-name[data-id="${id}"]`).value.trim();
    const location = document.querySelector(`.edit-location[data-id="${id}"]`).value.trim();
    try {
        const res = await fetch(`http://127.0.0.1:5000/api/devices/${id}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name, location})
        });
        if(!res.ok){
            const err = await res.json();
            alert(err.error);
        }
        fetchDevices();
    } catch(err) { console.error(err); }
}

async function deleteDevice(id){
    if(!confirm('Supprimer ce device ?')) return;
    try {
        await fetch(`http://127.0.0.1:5000/api/devices/${id}`, {method:'DELETE'});
        fetchDevices();
    } catch(err){ console.error(err); }
}

async function toggleActuator(id){
    const row = document.querySelector(`.edit-name[data-id="${id}"]`).closest('tr');
    const state = row.querySelector('td:nth-child(5)').innerText === 'on' ? 'off' : 'on';
    try {
        await fetch(`http://127.0.0.1:5000/api/devices/${id}/write`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({state})
        });
        fetchDevices();
    } catch(err){ console.error(err); }
}

document.getElementById('addForm').addEventListener('submit', addDevice);
fetchDevices();
setInterval(fetchDevices, 5000); // rafraîchissement auto toutes les 5s
</script>
</body>
</html>
